name: Discord Commit Notifications

on:
  push:
    branches: [ main ]

jobs:
  notify:
    runs-on: self-hosted
    steps:
      - name: Send Discord Notification
        continue-on-error: true
        shell: bash
        env:
          DISCORD_WEBHOOK: ${{ secrets.COMMIT_WEBHOOK }}
        run: |
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -n 1)
          AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.event.head_commit.url }}"
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)
          BRANCH="${{ github.ref_name }}"
          REPO="${{ github.repository }}"

          COLOR=5793266  # Discord blurple color

          PAYLOAD=$(cat <<EOF
          {
            "username": "GitHub Commits",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
              "title": "ðŸ“ New Commit to $REPO",
              "description": "$COMMIT_MSG",
              "url": "$COMMIT_URL",
              "color": $COLOR,
              "fields": [
                {
                  "name": "Author",
                  "value": "$AUTHOR",
                  "inline": true
                },
                {
                  "name": "Commit",
                  "value": "[\`$SHORT_SHA\`]($COMMIT_URL)",
                  "inline": true
                },
                {
                  "name": "Branch",
                  "value": "$BRANCH",
                  "inline": true
                }
              ],
              "timestamp": "${{ github.event.head_commit.timestamp }}"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK"
